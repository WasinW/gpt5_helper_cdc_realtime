#!/usr/bin/env bash
set -euo pipefail
BRANCH="feature/cdc-refactor-full"
git rev-parse --is-inside-work-tree >/dev/null 2>&1 || { echo "❌ Not a git repo. cd into your repo first."; exit 1; }
git fetch origin || true
if git show-ref --verify --quiet refs/heads/$BRANCH; then git checkout $BRANCH; else git checkout -b $BRANCH origin/main || git checkout -b $BRANCH; fi
python3 - <<'PY'
import base64, gzip, pathlib
infra = """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"""; fw = """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"""
pathlib.Path("./patch_infra_v1.patch").write_bytes(gzip.decompress(base64.b64decode(infra)))
pathlib.Path("./patch_framework_member_v1.patch").write_bytes(gzip.decompress(base64.b64decode(fw)))
print("materialized patches")
PY
git apply --whitespace=fix ./patch_infra_v1.patch || true
git add -A && git commit -m "infra: buckets/pubsub/datasets + params + docs (dev, SG)" || echo "(infra: nothing to commit)"
git apply --whitespace=fix ./patch_framework_member_v1.patch || true
git add -A && git commit -m "feat: framework backend + member pipeline (create/update topics, API fetcher, GCS logs)" || echo "(framework+member: nothing to commit)"
git push -u origin "$BRANCH"
echo "✅ Done. Open PR from $BRANCH → main"
